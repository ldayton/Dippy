name: Add CLI Command Support

on:
  workflow_dispatch:
    inputs:
      command:
        description: 'CLI command to add support for (e.g., ansible, terraform)'
        required: true
        type: string
      brew_tap:
        description: 'Optional Homebrew tap (e.g., hashicorp/tap)'
        required: false
        type: string

jobs:
  add-command:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Clone tldr pages
        run: git clone --depth 1 https://github.com/tldr-pages/tldr.git ~/tldr

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@main

      - name: Install command via brew
        run: |
          if [ -n "${{ inputs.brew_tap }}" ]; then
            brew tap ${{ inputs.brew_tap }}
            brew install ${{ inputs.brew_tap }}/${{ inputs.command }}
          else
            brew install ${{ inputs.command }}
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'
          allow-prereleases: true

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --dev

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          use_bedrock: "true"
          prompt: |
            Add support for the '${{ inputs.command }}' CLI command following the process in prompts/adding-commands.md.

            Reference materials:
            - tldr pages are at ~/tldr/pages/common/, ~/tldr/pages/linux/, ~/tldr/pages/osx/
            - Man pages: run `man ${{ inputs.command }}` or `man ${{ inputs.command }}-<subcommand>`
            - Help: run `${{ inputs.command }} --help`

            Steps:
            1. Read the tldr page and man page to understand safe vs unsafe operations
            2. Create tests in tests/cli/test_${{ inputs.command }}.py
            3. Create the handler in src/dippy/cli/${{ inputs.command }}.py
            4. Register it in src/dippy/cli/__init__.py
            5. Run tests: uv run pytest tests/cli/test_${{ inputs.command }}.py -v
            6. Run linter: uv run ruff check src/ tests/
            7. Fix any issues until tests and linter pass

            Do not create a git commit or PR.
          claude_args: |
            --model us.anthropic.claude-opus-4-5-20251101-v1:0
            --allowedTools Read,Edit,Write,Bash,Glob,Grep

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add ${{ inputs.command }} CLI support"
          branch: add-${{ inputs.command }}-support
          delete-branch: true
          title: "Add ${{ inputs.command }} CLI support"
          body: |
            ## Summary
            - Add handler for `${{ inputs.command }}` CLI
            - Add tests covering safe/unsafe operations

            ## Test plan
            - [ ] All new tests pass
            - [ ] Linter passes

            ---
            *Generated by Claude Code (Opus 4.5)*
